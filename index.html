<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LENS LOG</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0d0e;
    --surface: #151517;
    --surface2: #1c1c1f;
    --surface3: #222226;
    --border: #2c2c31;
    --accent: #e8ff47;
    --accent2: #ff9f47;
    --text: #f0f0ee;
    --muted: #65656f;
    --danger: #ff4444;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; overflow: hidden; background: var(--bg); color: var(--text); font-family: 'Noto Sans JP', sans-serif; font-weight: 300; }
  .app { display: flex; flex-direction: column; height: 100dvh; }

  /* â”€â”€ HEADER â”€â”€ */
  .header {
    flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px; background: var(--surface); border-bottom: 1px solid var(--border);
  }
  .logo { font-family: 'Bebas Neue', sans-serif; font-size: 24px; letter-spacing: 4px; color: var(--accent); }
  .header-right { display: flex; gap: 8px; }
  .btn-sm { background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--muted); font-family: 'DM Mono', monospace; font-size: 11px; padding: 7px 12px; cursor: pointer; transition: all 0.15s; }
  .btn-sm:active { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ TOP PANEL â”€â”€ */
  .top-panel { flex: 0 0 auto; max-height: 62dvh; overflow-y: auto; background: var(--surface); border-bottom: 2px solid var(--border); }

  .form-area { padding: 14px 16px 18px; display: flex; flex-direction: column; gap: 14px; }

  /* â”€â”€ AI SCAN BUTTON â”€â”€ */
  .ai-scan-btn {
    width: 100%; padding: 15px; border: none; border-radius: 12px;
    background: linear-gradient(135deg, #1a1a1f 0%, #222228 100%);
    border: 1.5px solid var(--accent);
    display: flex; align-items: center; justify-content: center; gap: 10px;
    cursor: pointer; transition: all 0.15s; position: relative; overflow: hidden;
  }
  .ai-scan-btn::before {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(135deg, rgba(232,255,71,0.08) 0%, transparent 60%);
  }
  .ai-scan-btn:active { transform: scale(0.98); }
  .ai-scan-icon { font-size: 22px; }
  .ai-scan-label { display: flex; flex-direction: column; align-items: flex-start; }
  .ai-scan-main { font-weight: 700; font-size: 14px; color: var(--accent); letter-spacing: 0.5px; }
  .ai-scan-sub { font-size: 10px; color: var(--muted); font-family: 'DM Mono', monospace; margin-top: 1px; }

  /* â”€â”€ AI RESULT CARD â”€â”€ */
  .ai-result {
    display: none; background: var(--surface2); border: 1px solid var(--accent);
    border-radius: 10px; overflow: hidden;
  }
  .ai-result.show { display: block; }
  .ai-result-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 12px; background: rgba(232,255,71,0.07); border-bottom: 1px solid var(--border);
  }
  .ai-result-badge { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--accent); letter-spacing: 1px; display: flex; align-items: center; gap: 5px; }
  .ai-result-retry { background: none; border: none; color: var(--muted); font-size: 11px; cursor: pointer; font-family: 'DM Mono', monospace; padding: 2px 6px; border-radius: 4px; }
  .ai-result-retry:active { color: var(--accent); }
  .ai-result-body { padding: 12px; display: flex; flex-direction: column; gap: 8px; }
  .ai-result-row { display: flex; flex-direction: column; gap: 3px; }
  .ai-result-lbl { font-size: 9px; font-family: 'DM Mono', monospace; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
  .ai-result-val { font-size: 13px; color: var(--text); line-height: 1.5; }

  /* â”€â”€ FIELDS â”€â”€ */
  .field { display: flex; flex-direction: column; gap: 5px; }
  .field label { font-size: 9px; font-family: 'DM Mono', monospace; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; }
  .field input, .field textarea {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
    padding: 10px 12px; color: var(--text); font-family: 'Noto Sans JP', sans-serif;
    font-size: 13px; font-weight: 300; outline: none; width: 100%; -webkit-appearance: none;
    transition: border-color 0.15s;
  }
  .field input:focus, .field textarea:focus { border-color: var(--accent); }
  .field input::placeholder, .field textarea::placeholder { color: var(--muted); font-size: 12px; }
  .field textarea { resize: none; }
  .field input.ai-filled { border-color: var(--accent); background: rgba(232,255,71,0.04); }

  .price-wrap { position: relative; }
  .price-wrap input { padding-left: 22px; }
  .price-yen { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--muted); font-family: 'DM Mono', monospace; font-size: 12px; pointer-events: none; }

  /* â”€â”€ IMAGES â”€â”€ */
  .images-label { font-size: 9px; font-family: 'DM Mono', monospace; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; }

  .main-img-area {
    width: 100%; height: 150px;
    border: 2px dashed var(--border); border-radius: 10px;
    background: var(--surface2); display: flex; align-items: center; justify-content: center;
    cursor: pointer; overflow: hidden; position: relative; transition: border-color 0.2s;
  }
  .main-img-area.has-img { border-style: solid; border-color: var(--accent); }
  .main-img-area img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .main-img-hint { color: var(--muted); font-size: 12px; text-align: center; line-height: 1.9; }
  .main-img-hint span { font-size: 24px; display: block; color: var(--muted); }

  .img-remove-btn {
    position: absolute; top: 6px; right: 6px;
    background: rgba(0,0,0,0.65); border: none; border-radius: 50%;
    color: #fff; width: 24px; height: 24px; font-size: 11px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
  }

  .sub-imgs-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
  .sub-img-slot {
    aspect-ratio: 1; border: 1.5px dashed var(--border); border-radius: 8px;
    background: var(--surface2); display: flex; align-items: center; justify-content: center;
    cursor: pointer; overflow: hidden; position: relative;
  }
  .sub-img-slot.has-img { border-style: solid; border-color: var(--border); }
  .sub-img-slot img { width: 100%; height: 100%; object-fit: cover; }
  .sub-img-add { color: var(--muted); font-size: 20px; }
  .sub-img-slot .img-remove-btn { width: 18px; height: 18px; font-size: 9px; top: 2px; right: 2px; }

  .btn-camera {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    width: 100%; padding: 10px; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--muted); font-size: 13px;
    font-family: 'Noto Sans JP', sans-serif; cursor: pointer;
  }
  .btn-camera:active { border-color: var(--accent); color: var(--accent); }

  .submit-btn {
    width: 100%; padding: 13px; background: var(--accent); border: none; border-radius: 8px;
    color: #0d0d0e; font-family: 'Noto Sans JP', sans-serif; font-weight: 700;
    font-size: 14px; letter-spacing: 2px; cursor: pointer;
  }
  .submit-btn:active { transform: scale(0.98); background: #d4eb30; }

  /* â”€â”€ BOTTOM â”€â”€ */
  .bottom-panel { flex: 1 1 0; display: flex; flex-direction: column; min-height: 0; }
  .bottom-header { flex-shrink: 0; display: flex; align-items: center; gap: 10px; padding: 10px 16px; border-bottom: 1px solid var(--border); background: var(--surface); }
  .stats { display: flex; gap: 12px; flex-shrink: 0; }
  .stat { text-align: center; }
  .stat-val { font-family: 'Bebas Neue', sans-serif; font-size: 20px; color: var(--accent); line-height: 1; }
  .stat-lbl { font-family: 'DM Mono', monospace; font-size: 8px; color: var(--muted); letter-spacing: 1px; }
  .vdiv { width: 1px; height: 32px; background: var(--border); flex-shrink: 0; }
  .search-input { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 12px; outline: none; -webkit-appearance: none; }
  .search-input:focus { border-color: var(--accent); }

  .grid-wrap { flex: 1; overflow-y: auto; padding: 12px; -webkit-overflow-scrolling: touch; }
  .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; animation: pop 0.25s ease; cursor: pointer; }
  @keyframes pop { from { opacity: 0; transform: scale(0.93); } to { opacity: 1; transform: scale(1); } }
  .card:active { border-color: var(--accent); }
  .card-img { width: 100%; height: 120px; object-fit: cover; display: block; }
  .card-no-img { width: 100%; height: 120px; background: var(--surface2); display: flex; align-items: center; justify-content: center; font-size: 30px; color: var(--border); }
  .card-body { padding: 8px 10px; }
  .card-name { font-weight: 500; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
  .card-brand { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--accent2); margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .card-price { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--accent); }
  .card-footer { display: flex; align-items: center; justify-content: space-between; padding: 5px 10px; border-top: 1px solid var(--border); }
  .card-date { font-family: 'DM Mono', monospace; font-size: 9px; color: var(--muted); }
  .card-del { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 13px; padding: 2px 5px; }
  .card-del:active { color: var(--danger); }
  .empty { grid-column: 1/-1; text-align: center; padding: 40px 20px; color: var(--muted); }
  .empty-icon { font-size: 36px; margin-bottom: 8px; }
  .empty-txt { font-family: 'DM Mono', monospace; font-size: 11px; }

  /* â”€â”€ AI LOADING OVERLAY â”€â”€ */
  .ai-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.88);
    z-index: 600; align-items: center; justify-content: center; flex-direction: column; gap: 16px;
  }
  .ai-overlay.open { display: flex; }
  .ai-spinner { width: 48px; height: 48px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .ai-overlay-label { font-family: 'DM Mono', monospace; font-size: 13px; color: var(--muted); letter-spacing: 1px; }
  .ai-overlay-sub { font-size: 11px; color: var(--border); font-family: 'DM Mono', monospace; }

  /* â”€â”€ CAMERA MODAL â”€â”€ */
  .camera-modal { display: none; position: fixed; inset: 0; background: #000; z-index: 500; flex-direction: column; }
  .camera-modal.open { display: flex; }
  .camera-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: rgba(0,0,0,0.75); position: absolute; top: 0; left: 0; right: 0; z-index: 10; }
  .camera-title { font-family: 'Bebas Neue', sans-serif; font-size: 20px; letter-spacing: 3px; color: var(--accent); }
  .camera-subtitle { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); margin-top: 2px; }
  .camera-close { background: none; border: 1px solid var(--border); border-radius: 6px; color: var(--muted); font-size: 13px; padding: 6px 12px; cursor: pointer; font-family: 'DM Mono', monospace; }
  #videoEl { width: 100%; height: 100dvh; object-fit: cover; }
  .camera-footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px 24px 36px; background: linear-gradient(transparent, rgba(0,0,0,0.85)); display: flex; align-items: center; justify-content: center; gap: 20px; }
  .shutter-btn { width: 68px; height: 68px; border-radius: 50%; background: #fff; border: 4px solid rgba(255,255,255,0.4); cursor: pointer; flex-shrink: 0; }
  .shutter-btn:active { transform: scale(0.9); }
  .cam-gallery-btn { width: 48px; height: 48px; border-radius: 10px; background: var(--surface2); border: 1px solid var(--border); font-size: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

  /* â”€â”€ DETAIL MODAL â”€â”€ */
  .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 300; align-items: flex-end; }
  .modal-bg.open { display: flex; }
  .detail-modal { background: var(--surface); border-radius: 16px 16px 0 0; width: 100%; max-height: 90dvh; overflow-y: auto; animation: slideUp 0.25s cubic-bezier(0.34,1.56,0.64,1); }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 12px auto 0; }
  .modal-main-img { width: 100%; max-height: 240px; object-fit: cover; display: block; margin-top: 12px; }
  .modal-sub-row { display: flex; gap: 6px; padding: 10px 16px 0; overflow-x: auto; }
  .modal-sub-img { width: 72px; height: 72px; object-fit: cover; border-radius: 6px; flex-shrink: 0; border: 1px solid var(--border); }
  .modal-body { padding: 16px; }
  .modal-brand { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--accent2); letter-spacing: 1px; margin-bottom: 4px; }
  .modal-name { font-weight: 700; font-size: 16px; margin-bottom: 4px; line-height: 1.4; }
  .modal-ai-desc { font-size: 12px; color: var(--muted); line-height: 1.6; margin-bottom: 10px; background: var(--surface2); padding: 10px 12px; border-radius: 6px; border-left: 2px solid var(--accent); }
  .modal-price { font-family: 'Bebas Neue', sans-serif; font-size: 24px; color: var(--accent); margin-bottom: 10px; }
  .modal-note { font-size: 13px; color: var(--muted); line-height: 1.7; margin-bottom: 12px; white-space: pre-wrap; }
  .modal-date { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--border); margin-bottom: 16px; }
  .modal-close { width: 100%; padding: 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--muted); font-family: 'DM Mono', monospace; font-size: 13px; cursor: pointer; }

  /* â”€â”€ TOAST â”€â”€ */
  .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(80px); background: var(--accent); color: #0d0d0e; padding: 10px 20px; border-radius: 20px; font-family: 'DM Mono', monospace; font-size: 12px; font-weight: 500; opacity: 0; transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1); z-index: 999; white-space: nowrap; pointer-events: none; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  ::-webkit-scrollbar { width: 3px; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  #canvas { display: none; }
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <div class="header">
    <div class="logo">LENS LOG</div>
    <div class="header-right">
      <button class="btn-sm" onclick="exportCSV()">ğŸ“¥ CSV</button>
    </div>
  </div>

  <!-- TOP PANEL -->
  <div class="top-panel">
    <div class="form-area">

      <!-- AI ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ -->
      <button class="ai-scan-btn" onclick="startAIScan()">
        <span class="ai-scan-icon">ğŸ¤–</span>
        <div class="ai-scan-label">
          <div class="ai-scan-main">AI ã§å•†å“ã‚’è­˜åˆ¥ã™ã‚‹</div>
          <div class="ai-scan-sub">å†™çœŸã‚’æ’®ã‚‹ or é¸ã¶ â†’ ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»å•†å“åã‚’è‡ªå‹•èªè­˜</div>
        </div>
      </button>

      <!-- AI çµæœã‚«ãƒ¼ãƒ‰ -->
      <div class="ai-result" id="aiResult">
        <div class="ai-result-header">
          <div class="ai-result-badge">âœ¨ AI è­˜åˆ¥çµæœ</div>
          <button class="ai-result-retry" onclick="startAIScan()">å†ã‚¹ã‚­ãƒ£ãƒ³</button>
        </div>
        <div class="ai-result-body">
          <div class="ai-result-row">
            <div class="ai-result-lbl">ãƒ–ãƒ©ãƒ³ãƒ‰ / ç¨®åˆ¥</div>
            <div class="ai-result-val" id="aiResultBrand">â€”</div>
          </div>
          <div class="ai-result-row">
            <div class="ai-result-lbl">å•†å“å / è©³ç´°</div>
            <div class="ai-result-val" id="aiResultName">â€”</div>
          </div>
          <div class="ai-result-row">
            <div class="ai-result-lbl">ç‰¹å¾´ãƒ»çŠ¶æ…‹</div>
            <div class="ai-result-val" id="aiResultDesc">â€”</div>
          </div>
        </div>
      </div>

      <!-- â‘  å•†å“ã‚¿ã‚¤ãƒˆãƒ« -->
      <div class="field">
        <label>â‘  å•†å“ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¿®æ­£å¯ï¼‰</label>
        <input type="text" id="itemName" placeholder="AIè­˜åˆ¥å¾Œã«è‡ªå‹•å…¥åŠ› or æ‰‹å‹•å…¥åŠ›">
      </div>

      <!-- â‘¡ ãƒ–ãƒ©ãƒ³ãƒ‰ -->
      <div class="field">
        <label>â‘¡ ãƒ–ãƒ©ãƒ³ãƒ‰ / ç¨®åˆ¥</label>
        <input type="text" id="itemBrand" placeholder="ä¾‹: Louis Vuitton, ã‚¢ãƒ³ãƒ†ã‚£ãƒ¼ã‚¯é™¶å™¨">
      </div>

      <!-- â‘¢ é‡‘é¡ -->
      <div class="field">
        <label>â‘¢ é‡‘é¡</label>
        <div class="price-wrap">
          <span class="price-yen">Â¥</span>
          <input type="number" id="itemPrice" placeholder="0" min="0" inputmode="numeric">
        </div>
      </div>

      <!-- â‘£ ç”»åƒ -->
      <div class="field">
        <div class="images-label" style="margin-bottom:8px">â‘£ ç”»åƒï¼ˆãƒ¡ã‚¤ãƒ³1æš ï¼‹ è¿½åŠ æœ€å¤§5æšï¼‰</div>
        <div class="main-img-area" id="mainImgArea" onclick="pickMain()">
          <div class="main-img-hint"><span>ğŸ–¼ï¸</span>ã‚¿ãƒƒãƒ—ã—ã¦ç”»åƒã‚’è¿½åŠ </div>
        </div>
        <div style="margin-top:8px">
          <div class="sub-imgs-grid" id="subImgsGrid"></div>
        </div>
        <button class="btn-camera" style="margin-top:8px" onclick="openCamera('sub')">ğŸ“· ã‚«ãƒ¡ãƒ©ã§è¿½åŠ ç”»åƒã‚’æ’®å½±</button>
      </div>

      <!-- â‘¤ ãƒ¡ãƒ¢ -->
      <div class="field">
        <label>â‘¤ ãƒ¡ãƒ¢</label>
        <textarea id="itemNote" rows="2" placeholder="è³¼å…¥å…ˆãƒ»çŠ¶æ…‹ãƒ»ã‚µã‚¤ã‚ºãƒ»ä»˜å±å“ãªã©"></textarea>
      </div>

      <button class="submit-btn" onclick="addItem()">è¨˜éŒ²ã™ã‚‹ â†’</button>
    </div>
  </div>

  <!-- BOTTOM -->
  <div class="bottom-panel">
    <div class="bottom-header">
      <div class="stats">
        <div class="stat"><div class="stat-val" id="sCount">0</div><div class="stat-lbl">ITEMS</div></div>
        <div class="vdiv"></div>
        <div class="stat"><div class="stat-val" id="sTotal">Â¥0</div><div class="stat-lbl">TOTAL</div></div>
      </div>
      <div class="vdiv"></div>
      <input class="search-input" type="text" placeholder="ğŸ” æ¤œç´¢â€¦" oninput="render(this.value)">
    </div>
    <div class="grid-wrap"><div class="grid" id="grid"></div></div>
  </div>
</div>

<!-- file inputs -->
<input type="file" id="fileMain" accept="image/*" style="display:none" onchange="onFileMain(this)">
<input type="file" id="fileSub" accept="image/*" style="display:none" onchange="onFileSub(this)">

<!-- AI OVERLAY -->
<div class="ai-overlay" id="aiOverlay">
  <div class="ai-spinner"></div>
  <div class="ai-overlay-label">AI ãŒç”»åƒã‚’è§£æä¸­â€¦</div>
  <div class="ai-overlay-sub">ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»å•†å“åãƒ»ç‰¹å¾´ã‚’è­˜åˆ¥ã—ã¦ã„ã¾ã™</div>
</div>

<!-- CAMERA MODAL -->
<div class="camera-modal" id="cameraModal">
  <div class="camera-header">
    <div>
      <div class="camera-title">SCAN</div>
      <div class="camera-subtitle" id="camSubtitle">å•†å“ã‚’æ’®å½±ã—ã¦ãã ã•ã„</div>
    </div>
    <button class="camera-close" onclick="closeCamera()">âœ• é–‰ã˜ã‚‹</button>
  </div>
  <video id="videoEl" autoplay playsinline muted></video>
  <div class="camera-footer">
    <div class="cam-gallery-btn" onclick="triggerGallery()">ğŸ–¼ï¸</div>
    <button class="shutter-btn" onclick="shootPhoto()"></button>
    <div style="width:48px"></div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div class="modal-bg" id="modal" onclick="bgClose(event)">
  <div class="detail-modal">
    <div class="modal-handle"></div>
    <img id="mMainImg" class="modal-main-img" src="" alt="" style="display:none">
    <div class="modal-sub-row" id="mSubRow"></div>
    <div class="modal-body">
      <div class="modal-brand" id="mBrand"></div>
      <div class="modal-name" id="mName"></div>
      <div class="modal-ai-desc" id="mDesc" style="display:none"></div>
      <div class="modal-price" id="mPrice"></div>
      <div class="modal-note" id="mNote"></div>
      <div class="modal-date" id="mDate"></div>
      <button class="modal-close" onclick="document.getElementById('modal').classList.remove('open')">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<canvas id="canvas"></canvas>

<script>
const KEY = 'lenslog_v4';
let items = [];
let mainImg = null;
let subImgs = [null, null, null, null, null];
let stream = null;
let cameraMode = 'ai'; // 'ai' or 'sub'
let pendingSubIdx = -1;

/* â”€â”€ STORAGE â”€â”€ */
function load() { try { items = JSON.parse(localStorage.getItem(KEY)) || []; } catch { items = []; } }
function save() { localStorage.setItem(KEY, JSON.stringify(items)); }

/* â”€â”€ AI SCAN â”€â”€ */
function startAIScan() {
  cameraMode = 'ai';
  openCamera('ai');
}

async function runAIAnalysis(imageData) {
  document.getElementById('aiOverlay').classList.add('open');
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{
          role: 'user',
          content: [
            {
              type: 'image',
              source: { type: 'base64', media_type: 'image/jpeg', data: imageData.split(',')[1] }
            },
            {
              type: 'text',
              text: `ã“ã®ç”»åƒã«å†™ã£ã¦ã„ã‚‹å•†å“ã‚’è©³ã—ãè­˜åˆ¥ã—ã¦ãã ã•ã„ã€‚ãƒ–ãƒ©ãƒ³ãƒ‰ãƒãƒƒã‚°ã€ã‚¢ãƒ³ãƒ†ã‚£ãƒ¼ã‚¯å“ã€é›‘è²¨ãªã©ãŒå¯¾è±¡ã§ã™ã€‚

ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜æ–‡ä¸è¦ï¼‰:
{
  "brand": "ãƒ–ãƒ©ãƒ³ãƒ‰åã¾ãŸã¯ç¨®åˆ¥ï¼ˆä¾‹: Louis Vuitton / ã‚¢ãƒ³ãƒ†ã‚£ãƒ¼ã‚¯é™¶å™¨ / ä¸æ˜ï¼‰",
  "name": "å•†å“åã¾ãŸã¯è©³ç´°åç§°ï¼ˆä¾‹: ãƒ¢ãƒã‚°ãƒ©ãƒ  ãƒãƒ´ã‚¡ãƒ¼ãƒ•ãƒ« MM / æ˜æ²»æœŸ ä¼Šä¸‡é‡Œç„¼ èŠ±ç“¶ï¼‰",
  "description": "ç‰¹å¾´ãƒ»çŠ¶æ…‹ãƒ»ç´ æãƒ»æ™‚ä»£ãªã©ã®è©³ç´°èª¬æ˜ï¼ˆ2ã€œ3æ–‡ï¼‰",
  "confidence": "high / medium / low"
}`
            }
          ]
        }]
      })
    });

    const data = await res.json();
    const textBlock = (data.content || []).find(b => b.type === 'text');
    const raw = textBlock ? textBlock.text.trim() : '';

    // JSONæŠ½å‡º
    const jsonMatch = raw.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('parse error');
    const result = JSON.parse(jsonMatch[0]);

    document.getElementById('aiOverlay').classList.remove('open');

    // çµæœã‚’UIã«åæ˜ 
    document.getElementById('aiResultBrand').textContent = result.brand || 'â€”';
    document.getElementById('aiResultName').textContent = result.name || 'â€”';
    document.getElementById('aiResultDesc').textContent = result.description || 'â€”';
    document.getElementById('aiResult').classList.add('show');

    // ãƒ•ã‚©ãƒ¼ãƒ ã«è‡ªå‹•å…¥åŠ›
    document.getElementById('itemName').value = result.name || '';
    document.getElementById('itemBrand').value = result.brand || '';
    document.getElementById('itemName').classList.add('ai-filled');
    document.getElementById('itemBrand').classList.add('ai-filled');

    // ãƒ¡ã‚¤ãƒ³ç”»åƒã«ã‚‚ã‚»ãƒƒãƒˆ
    mainImg = imageData;
    renderMainImg();

    toast('âœ… AIè­˜åˆ¥å®Œäº†ï¼å†…å®¹ã‚’ç¢ºèªãƒ»ä¿®æ­£ã—ã¦ãã ã•ã„');

    // ä¿¡é ¼åº¦ãŒä½ã„å ´åˆã¯æ³¨è¨˜
    if (result.confidence === 'low') {
      setTimeout(() => toast('âš ï¸ è­˜åˆ¥ç²¾åº¦ãŒä½ã‚ã§ã™ã€‚å†…å®¹ã‚’ã”ç¢ºèªãã ã•ã„'), 2000);
    }

  } catch (e) {
    document.getElementById('aiOverlay').classList.remove('open');
    // ç”»åƒã¯ã‚»ãƒƒãƒˆ
    mainImg = imageData;
    renderMainImg();
    toast('âš ï¸ AIè­˜åˆ¥ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
  }
}

/* â”€â”€ CAMERA â”€â”€ */
async function openCamera(mode) {
  cameraMode = mode;
  document.getElementById('camSubtitle').textContent =
    mode === 'ai' ? 'AIã§è­˜åˆ¥ã™ã‚‹å•†å“ã‚’æ’®å½±' : 'è¿½åŠ ç”»åƒã‚’æ’®å½±';
  document.getElementById('cameraModal').classList.add('open');
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
    document.getElementById('videoEl').srcObject = stream;
  } catch {
    document.getElementById('cameraModal').classList.remove('open');
    toast('âš ï¸ ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„');
  }
}

function closeCamera() {
  document.getElementById('cameraModal').classList.remove('open');
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
}

function shootPhoto() {
  const video = document.getElementById('videoEl');
  const canvas = document.getElementById('canvas');
  canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  const data = canvas.toDataURL('image/jpeg', 0.85);
  closeCamera();

  if (cameraMode === 'ai') {
    runAIAnalysis(data);
  } else {
    setSubImg(data);
  }
}

function triggerGallery() {
  closeCamera();
  if (cameraMode === 'ai') {
    document.getElementById('fileMain').click();
  } else {
    document.getElementById('fileSub').click();
  }
}

/* â”€â”€ FILE INPUTS â”€â”€ */
function pickMain() { document.getElementById('fileMain').click(); }

function onFileMain(input) {
  const f = input.files[0]; if (!f) return;
  readFile(f, data => {
    if (cameraMode === 'ai') {
      runAIAnalysis(data);
    } else {
      mainImg = data; renderMainImg();
    }
  });
  input.value = '';
}

function onFileSub(input) {
  const f = input.files[0]; if (!f) return;
  readFile(f, data => setSubImg(data));
  input.value = '';
}

function setSubImg(data) {
  const idx = pendingSubIdx >= 0 ? pendingSubIdx : subImgs.indexOf(null);
  if (idx === -1) { toast('âš ï¸ è¿½åŠ ç”»åƒã¯æœ€å¤§5æšã§ã™'); return; }
  subImgs[idx] = data;
  pendingSubIdx = -1;
  renderSubImgs();
}

function readFile(file, cb) {
  const r = new FileReader();
  r.onload = e => cb(e.target.result);
  r.readAsDataURL(file);
}

/* â”€â”€ RENDER IMAGES â”€â”€ */
function renderMainImg() {
  const area = document.getElementById('mainImgArea');
  if (mainImg) {
    area.classList.add('has-img');
    area.innerHTML = `<img src="${mainImg}" alt=""><button class="img-remove-btn" onclick="event.stopPropagation();mainImg=null;renderMainImg()">âœ•</button>`;
  } else {
    area.classList.remove('has-img');
    area.innerHTML = `<div class="main-img-hint"><span>ğŸ–¼ï¸</span>ã‚¿ãƒƒãƒ—ã—ã¦ç”»åƒã‚’è¿½åŠ </div>`;
  }
}

function renderSubImgs() {
  document.getElementById('subImgsGrid').innerHTML = subImgs.map((img, i) =>
    img
      ? `<div class="sub-img-slot has-img" onclick="pickSubSlot(${i})"><img src="${img}" alt=""><button class="img-remove-btn" onclick="event.stopPropagation();subImgs[${i}]=null;renderSubImgs()">âœ•</button></div>`
      : `<div class="sub-img-slot" onclick="pickSubSlot(${i})"><div class="sub-img-add">ï¼‹</div></div>`
  ).join('');
}

function pickSubSlot(i) {
  pendingSubIdx = i;
  cameraMode = 'sub';
  document.getElementById('fileSub').click();
}

/* â”€â”€ CRUD â”€â”€ */
function addItem() {
  const name = document.getElementById('itemName').value.trim();
  if (!name) { toast('âš ï¸ å•†å“ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const brand = document.getElementById('itemBrand').value.trim();
  const price = document.getElementById('itemPrice').value;
  const note = document.getElementById('itemNote').value.trim();
  const aiDesc = document.getElementById('aiResultDesc').textContent;

  items.unshift({
    id: Date.now(), name, brand,
    price: price ? parseInt(price) : null,
    note, mainImg,
    subImgs: [...subImgs],
    aiDesc: aiDesc !== 'â€”' ? aiDesc : '',
    date: new Date().toLocaleDateString('ja-JP')
  });
  save(); render(); updateStats(); resetForm(); toast('âœ… è¨˜éŒ²ã—ã¾ã—ãŸï¼');
}

function resetForm() {
  ['itemName','itemBrand','itemPrice','itemNote'].forEach(id => {
    const el = document.getElementById(id);
    el.value = '';
    el.classList.remove('ai-filled');
  });
  mainImg = null; subImgs = [null,null,null,null,null]; pendingSubIdx = -1;
  renderMainImg(); renderSubImgs();
  document.getElementById('aiResult').classList.remove('show');
  document.getElementById('aiResultBrand').textContent = 'â€”';
  document.getElementById('aiResultName').textContent = 'â€”';
  document.getElementById('aiResultDesc').textContent = 'â€”';
}

function del(id, e) {
  e.stopPropagation();
  items = items.filter(i => i.id !== id);
  save(); render(); updateStats(); toast('ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ');
}

function render(q = '') {
  const grid = document.getElementById('grid');
  const list = q
    ? items.filter(i => [i.name, i.brand, i.note].join(' ').toLowerCase().includes(q.toLowerCase()))
    : items;
  if (!list.length) {
    grid.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“­</div><div class="empty-txt">${q ? 'è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' : 'ã¾ã è¨˜éŒ²ãªã—'}</div></div>`;
    return;
  }
  grid.innerHTML = list.map(item => `
    <div class="card" onclick="openModal(${item.id})">
      ${item.mainImg ? `<img class="card-img" src="${item.mainImg}" alt="">` : `<div class="card-no-img">ğŸ·ï¸</div>`}
      <div class="card-body">
        ${item.brand ? `<div class="card-brand">${esc(item.brand)}</div>` : ''}
        <div class="card-name">${esc(item.name)}</div>
        <div class="card-price">${item.price != null ? 'Â¥'+item.price.toLocaleString() : 'â€”'}</div>
      </div>
      <div class="card-footer">
        <span class="card-date">${item.date}</span>
        <button class="card-del" onclick="del(${item.id},event)">âœ•</button>
      </div>
    </div>`).join('');
}

function updateStats() {
  document.getElementById('sCount').textContent = items.length;
  const total = items.filter(i => i.price != null).reduce((s, i) => s + i.price, 0);
  document.getElementById('sTotal').textContent = 'Â¥' + total.toLocaleString();
}

function openModal(id) {
  const item = items.find(i => i.id === id); if (!item) return;
  const mi = document.getElementById('mMainImg');
  if (item.mainImg) { mi.src = item.mainImg; mi.style.display = 'block'; } else { mi.style.display = 'none'; }
  const subs = (item.subImgs || []).filter(Boolean);
  const subRow = document.getElementById('mSubRow');
  subRow.style.display = subs.length ? 'flex' : 'none';
  subRow.innerHTML = subs.map(s => `<img class="modal-sub-img" src="${s}" alt="">`).join('');
  document.getElementById('mBrand').textContent = item.brand || '';
  document.getElementById('mName').textContent = item.name;
  const descEl = document.getElementById('mDesc');
  if (item.aiDesc) { descEl.textContent = item.aiDesc; descEl.style.display = 'block'; } else { descEl.style.display = 'none'; }
  document.getElementById('mPrice').textContent = item.price != null ? 'Â¥' + item.price.toLocaleString() : 'ä¾¡æ ¼æœªè¨­å®š';
  document.getElementById('mNote').textContent = item.note || '';
  document.getElementById('mDate').textContent = 'è¨˜éŒ²æ—¥: ' + item.date;
  document.getElementById('modal').classList.add('open');
}

function bgClose(e) { if (e.target === document.getElementById('modal')) document.getElementById('modal').classList.remove('open'); }

function exportCSV() {
  if (!items.length) { toast('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const rows = [['å•†å“ã‚¿ã‚¤ãƒˆãƒ«', 'ãƒ–ãƒ©ãƒ³ãƒ‰', 'é‡‘é¡', 'AIèª¬æ˜', 'ãƒ¡ãƒ¢', 'è¨˜éŒ²æ—¥'],
    ...items.map(i => [
      `"${(i.name||'').replace(/"/g,'""')}"`,
      `"${(i.brand||'').replace(/"/g,'""')}"`,
      i.price ?? '',
      `"${(i.aiDesc||'').replace(/"/g,'""').replace(/\n/g,' ')}"`,
      `"${(i.note||'').replace(/"/g,'""').replace(/\n/g,' ')}"`,
      i.date
    ])];
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob(['\uFEFF' + rows.map(r => r.join(',')).join('\n')], { type: 'text/csv;charset=utf-8;' }));
  a.download = `lenslog_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  toast('ğŸ“¥ CSVã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ');
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(t._t); t._t = setTimeout(() => t.classList.remove('show'), 2800);
}
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

load(); render(); updateStats(); renderMainImg(); renderSubImgs();
</script>
</body>
</html>
